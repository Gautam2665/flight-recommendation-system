<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='flight-details.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>SkyScout - Book Your Flight</title>
</head>

<body class="bg-gray-50">
{% include 'navbar.html' %}

<div class="container">

  <!-- FLIGHT CARDS -->
  <div class="flights-container">
    {% for flight in flights %}
    <div class="flight-card">

      <div class="flight-info">
        <img
          src="{{ flight.airline_logo or url_for('static', filename='airlines/default.png') }}"
          onerror="this.src='{{ url_for('static', filename='airlines/default.png') }}'"
          class="airline-logo"
          alt="{{ flight.airline }}"
        />
        <div class="airline">{{ flight.airline }}</div>
      </div>

      <div class="price-block">
        <div class="price">
          ₹{{ "%.2f"|format(flight.predicted_price) }}
        </div>
        <button class="details-btn">Check Details</button>
      </div>

    </div>
    {% endfor %}
  </div>

  <!-- FILTER SIDEBAR -->
  <aside class="w-full md:w-64 bg-white p-4 rounded-xl">

    <h3 class="font-semibold mb-3">Filters</h3>

    <!-- AIRLINES -->
    <div id="airline-filters"></div>

    <!-- STOPS -->
    <div id="stops-filters" class="mt-4"></div>

    <!-- PRICE -->
    <div class="mt-4">
      <span id="min-price">₹0</span> –
      <span id="max-price">₹0</span>
      <input id="price-range" type="range" class="w-full">
    </div>

    <button onclick="applyFilters()" class="mt-4 bg-blue-600 text-white w-full py-2 rounded">
      Apply Filters
    </button>
  </aside>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const params = new URLSearchParams(window.location.search);

  fetch(`/get-filters?${params.toString()}`)
    .then(r => r.json())
    .then(data => {

      /* AIRLINES */
      const airlineBox = document.getElementById("airline-filters");
      airlineBox.innerHTML = "";
      (data.airlines || []).forEach(a => {
        airlineBox.innerHTML += `
          <label>
            <input type="checkbox" class="airline-checkbox" value="${a}">
            ${a}
          </label><br>
        `;
      });

      /* STOPS */
      const stopBox = document.getElementById("stops-filters");
      stopBox.innerHTML = "";
      (data.stops || []).forEach(s => {
        const price = s.min_price ? `₹${s.min_price.toLocaleString("en-IN")}` : "—";
        stopBox.innerHTML += `
          <label>
            <input type="checkbox" class="stop-checkbox" value="${s.value}">
            ${s.label} <span>${price}</span>
          </label><br>
        `;
      });

      /* PRICE RANGE */
      const range = document.getElementById("price-range");
      range.min = data.min_price ?? 0;
      range.max = data.max_price ?? 0;
      range.value = params.get("max_price") || range.max;

      document.getElementById("min-price").textContent =
        `₹${(data.min_price ?? 0).toLocaleString("en-IN")}`;
      document.getElementById("max-price").textContent =
        `₹${range.value.toLocaleString("en-IN")}`;

      range.oninput = () => {
        document.getElementById("max-price").textContent =
          `₹${parseInt(range.value).toLocaleString("en-IN")}`;
      };
    })
    .catch(err => console.error("Filter error:", err));
});

/* APPLY FILTERS */
function applyFilters() {
  const params = new URLSearchParams(window.location.search);

  const airlines = [...document.querySelectorAll(".airline-checkbox:checked")]
    .map(e => e.value);
  airlines.length ? params.set("airline", airlines.join(",")) : params.delete("airline");

  const stops = [...document.querySelectorAll(".stop-checkbox:checked")]
    .map(e => e.value);
  stops.length ? params.set("stops", stops.join(",")) : params.delete("stops");

  const price = document.getElementById("price-range").value;
  price ? params.set("max_price", price) : params.delete("max_price");

  window.location.search = params.toString();
}
</script>

</body>
</html>
